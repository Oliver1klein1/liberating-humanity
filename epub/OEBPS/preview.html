<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xml:lang="en">
<head>
    <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8" />
    <title>eBook Preview</title>
    <style type="text/css">
        .preview-container {
            --content-width: 800px;
            margin: 0;
            padding: 20px;
            font-family: system-ui, -apple-system, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            background-color: #f5f5f5;
        }
        .preview-main {
            width: 100%;
            max-width: var(--content-width);
            margin: 0 auto;
        }
        .preview-frame {
            width: 100%;
            max-width: var(--content-width);
            min-height: 700px;
            border: none;
            background: white;
            padding: 20px;
            margin: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-radius: 5px;
            height: calc(100vh - 150px);
            overflow-y: auto;
            display: block;
            position: relative;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }
        .preview-navigation {
            width: 100%;
            max-width: var(--content-width);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2em;
            padding-top: 1em;
            border-top: 1px solid #eee;
            gap: 10px;
        }
        .preview-button {
            padding: 10px 20px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            font-weight: bold;
            min-width: 120px;
            text-align: center;
        }
        .preview-button:hover {
            background: #004499;
        }
        .preview-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .preview-button.contents {
            background: #28a745;
        }
        .preview-button.contents:hover {
            background: #218838;
        }
    </style>
</head>preview
<body class="preview-container">
    <main class="preview-main">
        <iframe id="content-frame" class="preview-frame" src="title.xhtml" onload="resizeIframe(this)" sandbox="allow-same-origin allow-scripts allow-forms allow-popups"></iframe>
        <div class="preview-navigation">
            <button id="prev-button" class="preview-button" onclick="navigateChapter('prev')" disabled="disabled">← Previous</button>
            <button id="contents-button" class="preview-button contents" onclick="loadChapter('toc.xhtml')">Contents</button>
            <button id="next-button" class="preview-button" onclick="navigateChapter('next')">Next →</button>
        </div>
    </main>
    <script type="text/javascript">
        //<![CDATA[
        const chapters = [
            'title.xhtml',
            'copyright.xhtml',
            'toc.xhtml',
            'intro.xhtml',
            'part1.xhtml',
            'chapter1.xhtml',
            'chapter2.xhtml',
            'chapter3.xhtml',
            'chapter4.xhtml',
            'part2.xhtml',
            'chapter5.xhtml',
            'chapter6.xhtml',
            'chapter7.xhtml',
            'part3.xhtml',
            'chapter8.xhtml',
            'chapter9.xhtml',
            'appendix1.xhtml',
            'appendix2.xhtml',
            'appendix3.xhtml',
            'bibliography.xhtml'
        ];

        function resizeIframe(obj) {
            try {
                const doc = obj.contentDocument || obj.contentWindow.document;
                const height = Math.max(
                    doc.body.scrollHeight,
                    doc.documentElement.scrollHeight,
                    doc.body.offsetHeight,
                    doc.documentElement.offsetHeight,
                    doc.body.clientHeight,
                    doc.documentElement.clientHeight
                );
                obj.style.height = height + 'px';
            } catch (e) {
                console.error('Error resizing iframe:', e);
            }
        }

        function getCurrentChapter() {
            const frame = document.getElementById('content-frame');
            const path = frame.src.split('/').pop().split('#')[0].split('?')[0];
            return path;
        }

        function loadChapter(href) {
            try {
                const frame = document.getElementById('content-frame');
                // Add timestamp to force fresh load
                const timestamp = new Date().getTime();
                frame.src = href + '?v=' + timestamp + '#top';
                updateNavigationButtons(href);
                
                // Reset the iframe's scroll position
                frame.style.height = 'auto';
                frame.scrollTop = 0;
                
                frame.onload = function() {
                    try {
                        // Force scroll to top immediately and after a delay
                        this.contentWindow.location.hash = 'top';
                        this.contentWindow.scrollTo(0, 0);
                        this.scrollTo(0, 0);
                        
                        // Double-check scroll position after content loads
                        setTimeout(() => {
                            this.contentWindow.scrollTo(0, 0);
                            this.scrollTo(0, 0);
                            resizeIframe(this);
                        }, 100);
                    } catch (e) {
                        console.error('Error in frame onload:', e);
                    }
                };
            } catch (e) {
                console.error('Error loading chapter:', e);
            }
        }

        function updateNavigationButtons(currentHref) {
            try {
                const basePath = currentHref.split('#')[0];
                const fileName = basePath.split('/').pop();
                const currentIndex = chapters.indexOf(fileName);
                const prevButton = document.getElementById('prev-button');
                const nextButton = document.getElementById('next-button');
                
                if (prevButton) prevButton.disabled = currentIndex <= 0;
                if (nextButton) nextButton.disabled = currentIndex >= chapters.length - 1;
            } catch (e) {
                console.error('Error updating navigation buttons:', e);
            }
        }

        function navigateChapter(direction) {
            try {
                const currentPath = getCurrentChapter();
                const currentIndex = chapters.indexOf(currentPath);
                
                if (direction === 'prev' && currentIndex > 0) {
                    loadChapter(chapters[currentIndex - 1]);
                } else if (direction === 'next' && currentIndex < chapters.length - 1) {
                    loadChapter(chapters[currentIndex + 1]);
                }
            } catch (e) {
                console.error('Error navigating chapter:', e);
            }
        }

        // Handle keyboard navigation
        document.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowLeft') {
                navigateChapter('prev');
            } else if (e.key === 'ArrowRight') {
                navigateChapter('next');
            }
        });

        // Handle messages from the iframe content
        window.addEventListener('message', function(event) {
            try {
                if (event.data && event.data.type === 'navigate') {
                    loadChapter(event.data.href);
                }
            } catch (e) {
                console.error('Error handling iframe message:', e);
            }
        });

        // Initialize with first chapter
        updateNavigationButtons('title.xhtml');

        // Add error handling for iframe load failures
        document.getElementById('content-frame').onerror = function(e) {
            console.error('Error loading iframe content:', e);
        };
        //]]>
    </script>
</body>
</html>